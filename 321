#include <opencv2/opencv.hpp>
#include <iostream>
#include <vector>

int main() {
    // 1. Загрузка изображения
    cv::Mat img = cv::imread("test_image.jpg");
    if (img.empty()) {
        std::cerr << "Ошибка: Не удалось загрузить изображение!" << std::endl;
        return -1;
    }

    cv::Mat hsv;
    cv::cvtColor(img, hsv, cv::COLOR_BGR2HSV);

    // 2. Выделяем канал Hue (H)
    std::vector<cv::Mat> channels;
    cv::split(hsv, channels);

    // 3. Расчет гистограммы
    int histSize = 180; // Диапазон Hue в OpenCV: 0-179
    float range[] = { 0, 180 };
    const float* histRange = { range };
    cv::Mat hist;
    cv::calcHist(&channels[0], 1, 0, cv::Mat(), hist, 1, &histSize, &histRange);

    // 4. Параметры визуализации
    int hist_w = 540, hist_h = 450; // Увеличили высоту для полоски
    int bin_w = cvRound((double)hist_w / histSize);
    cv::Mat histImage(hist_h, hist_w, CV_8UC3, cv::Scalar(20, 20, 20)); // Темный фон

    // Нормализуем гистограмму, чтобы она вписалась в окно (оставляем место снизу)
    cv::normalize(hist, hist, 0, hist_h - 100, cv::NORM_MINMAX);

    // 5. Поиск доминирующего цвета (пика)
    double maxVal = 0;
    cv::Point maxLoc;
    cv::minMaxLoc(hist, 0, &maxVal, 0, &maxLoc);
    int dominantHue = maxLoc.y; // Индекс самого высокого столбика

    // 6. Отрисовка гистограммы и цветной полоски
    for (int i = 0; i < histSize; i++) {
        // Рисуем линию гистограммы
        if (i > 0) {
            cv::line(histImage, 
                     cv::Point(bin_w*(i-1), (hist_h - 60) - cvRound(hist.at<float>(i-1))),
                     cv::Point(bin_w*(i), (hist_h - 60) - cvRound(hist.at<float>(i))),
                     cv::Scalar(255, 255, 255), 2);
        }

        // --- ЦВЕТНАЯ ПОЛОСОЧКА ---
        // Создаем временный пиксель в HSV и конвертируем в BGR для отрисовки
        cv::Mat colorPixel(1, 1, CV_8UC3, cv::Scalar(i, 255, 255));
        cv::Mat bgrPixel;
        cv::cvtColor(colorPixel, bgrPixel, cv::COLOR_HSV2BGR);
        cv::Scalar color(bgrPixel.at<cv::Vec3b>(0,0));

        // Рисуем прямоугольник цвета под соответствующим бином гистограммы
        cv::rectangle(histImage, 
                      cv::Point(i * bin_w, hist_h - 50), 
                      cv::Point((i + 1) * bin_w, hist_h), 
                      color, -1);
    }

    // 7. Добавляем текст анализа
    std::string analysis = "Dominant Hue: ~" + std::to_string(dominantHue * 2) + " degrees";
    cv::putText(histImage, analysis, cv::Point(20, 40), 
                cv::FONT_HERSHEY_SIMPLEX, 0.7, cv::Scalar(0, 255, 255), 2);

    cv::imshow("Hue Histogram with Color Scale", histImage);
    cv::waitKey(0);
    return 0;
}
